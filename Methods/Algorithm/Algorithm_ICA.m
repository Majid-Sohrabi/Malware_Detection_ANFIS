function Result=Algorithm_ICA(Model,Parameter)
tic;
costfunction=@(x)Model.FitnessFunction(x);
nVar = Model.Solution_lenght;
VarSize=[1 nVar];   % Variables Matrix Size
VarMin=Model.Solution_Floor;
VarMax= Model.Solution_Ceil;

MaxIteration=1000;
NCountry=50;
NImperial=10;
Beta=2;
Epselon=0.0001;
Gama=1;
Revolutionrate=0.1;
PDeflection=0.1;
delta=0.1;
%% initialization
Ncol=NCountry-NImperial ;
%% Country struct
Country.position=[];
Country.cost=[];
%% Country population
popCountry=repmat(Country,NCountry,1);
%% Initial country population
popCountry(1).position=ones(VarSize);
popCountry(1).cost=costfunction(popCountry(1).position) ;
for  i=2:NCountry
    popCountry(i).position=unifrnd(VarMin,VarMax,VarSize);
    popCountry(i).cost=costfunction(popCountry(i).position) ;
end
%% sort Countrys
costs=[popCountry.cost] ;
[costs locatesortedcost]=sort(costs) ;
popCountry=popCountry(locatesortedcost) ;
%% imperial struct
Imperial.position=[] ;
Imperial.cost=[] ;
Imperial.totalcost=[] ;
Imperial.colonies=[] ;
Imperial.Ncol=[] ;
%% Imperial population
Imperial=repmat(Imperial,NImperial,1) ;
%% Initial Imperial population
for i=1:NImperial
    Imperial(i).position=popCountry(i).position ;
    Imperial(i).cost=popCountry(i).cost ;
end
% remove imperial from countrys population
popCountry=popCountry(NImperial+1:end) ;
%% Condition for find error
if  isempty(popCountry)
    disp('Error!');
    return;
end
%%
impcosts=[Imperial.cost];
Maximpcost=max(impcosts);
impfitness=1.2*Maximpcost-impcosts;
p=impfitness/sum(impfitness);
nc=round(p*Ncol);
sumnc=sum(nc);
if sumnc>Ncol
    i=1;
    while sumnc>Ncol
        nc(i)=max(nc(i)-1,0);
        i=i+1;
        if i>NImperial
            i=1;
        end
        sumnc=sum(nc);
    end
elseif sumnc<Ncol
    i=NImperial;
    while sumnc<Ncol
        nc(i)=nc(i)+1;
        i=i-1;
        if i<1
            i=NImperial;
        end
        sumnc=sum(nc);
    end
end
%%
popCountry=popCountry(randperm(Ncol));

for  i=1:NImperial
    Imperial(i).Ncol=nc(i);
    Imperial(i).colonies=popCountry(1:nc(i));
    popCountry=popCountry(nc(i)+1:end);
end

Bestsol=[] ;
Bestcost=zeros(MaxIteration,1) ;
Time=zeros(MaxIteration,1) ;
Time(1)=toc;

%% ICA Main Loop
for gen=1:MaxIteration
    tic;
    %  assimilate colonies
    for i=1:NImperial
        for j=1:Imperial(i).Ncol
            Imperial(i).colonies(j).position =Imperial(i).colonies(j).position+Beta*rand...
                *(Imperial(i).position-Imperial(i).colonies(j).position) ;
            
            Imperial(i).colonies(j).position=max(Imperial(i).colonies(j).position,Model.Solution_Floor) ;
            Imperial(i).colonies(j).position=min(Imperial(i).colonies(j).position,Model.Solution_Ceil) ;
            Imperial(i).colonies(j).cost=costfunction(Imperial(i).colonies(j).position) ;
        end
    end
    
    % Deflection colonies
    for a=1:NImperial
        for b=1:Imperial(a).Ncol
            if rand<PDeflection
                Imperial(a).colonies(b).position=Imperial(a).colonies(b).position...
                    +PDeflection*unifrnd(-delta,delta,VarSize);
                Imperial(a).colonies(b).position=max(Imperial(a).colonies(b).position,Model.Solution_Floor) ;
                Imperial(a).colonies(b).position=min(Imperial(a).colonies(b).position,Model.Solution_Ceil) ;
                Imperial(a).colonies(b).cost=costfunction(Imperial(a).colonies(b).position) ;
            end
        end
    end
    
    % Revolution colonies
    for t=1:NImperial
        for y=1:Imperial(t).Ncol
            if rand<Revolutionrate
                m=randsample(nVar,1) ;
                k=randsample(nVar,m) ;
                u=1:2:nVar ;
                r=2:2:nVar ;
                for z=1:m
                    if intersect(k(z),u)>0
                        Imperial(t).colonies(y).position(k(z))=unifrnd(Model.Solution_Floor,Model.Solution_Ceil) ;
                    elseif intersect(k(z),r)>0
                        Imperial(t).colonies(y).position(k(z))=unifrnd(Model.Solution_Floor,Model.Solution_Ceil) ;
                    end
                end
                Imperial(t).colonies(y).cost=costfunction(Imperial(t).colonies(y).position) ;
            end
        end
    end
    
    %  Switch Imperialist and colonies if colonies had beter cost
    
    for q=1:NImperial
        colonycosts=[Imperial(q).colonies.cost] ;
        [Bestcolonycost Bestcolonylocate]=min(colonycosts) ;
        Bestcolony=Imperial(q).colonies(Bestcolonylocate) ;
        if Bestcolony.cost<Imperial(q).cost
            Imperial(q).colonies(Bestcolonylocate).position=Imperial(q).position ;
            Imperial(q).colonies(Bestcolonylocate).cost=Imperial(q).cost ;
            Imperial(q).position=Bestcolony.position ;
            Imperial(q).cost=Bestcolony.cost ;
        end
    end
    
    %  caculation total cost of imperialst
    
    for w=1:NImperial
        Imperial(w).totalcost=Imperial(w).cost+Epselon*mean([Imperial(w).colonies.cost]) ;
    end
    
    %%  Imperialist Competitive
    if NImperial<2
%         break ;
    else
        imptotalcost=[Imperial.totalcost] ;
        [Maximpcost NofMaximpcost]=max(imptotalcost) ;
        
        [Maxcolcost NofMaxcolcost]=max([Imperial(NofMaximpcost).colonies.cost]) ;
        impvalue=Maximpcost-[Imperial.totalcost] ;
        p=impvalue/sum(impvalue);
        l=RouletteWheelSelection(p,0.2) ;
        Imperial(l).colonies=[Imperial(l).colonies
            Imperial(NofMaximpcost).colonies(NofMaxcolcost)] ;
        
        Imperial(l).Ncol=numel([Imperial(l).colonies]) ;
        
        Imperial(NofMaximpcost).colonies(NofMaxcolcost)= [] ;
        
        Imperial(NofMaximpcost).Ncol=numel([Imperial(NofMaximpcost).colonies]) ;
        if  Imperial(NofMaximpcost).Ncol==0
            % weakest imp. will collapse
            L=RouletteWheelSelection(p,0.2) ;
            newcolony.position=Imperial(NofMaximpcost).position ;
            newcolony.cost=Imperial(NofMaximpcost).cost ;
            Imperial(L).colonies=[Imperial(L).colonies
                newcolony] ;
            Imperial(L).Ncol=numel([Imperial(L).colonies]) ;
            Imperial=Imperial([1:NofMaximpcost-1 NofMaximpcost+1:end]) ;
            NImperial=NImperial-1 ;
        end
    end
    
    %% final activity for show result
    [Bestimpcost Bestimpcostlocate]=min([Imperial.cost]) ;
    Bestimperial=Imperial(Bestimpcostlocate) ;
    Bestsol.position=Bestimperial.position ;
    Bestsol.cost=Bestimperial.cost ;
    Bestcost(gen)=Bestsol.cost ;
    
    disp(['Generation : (' num2str(gen) ') , Best cost is :' num2str(Bestcost(gen))]) ;
    Time(gen)=Time(gen)+toc;
%     if(sum(Time)>=3600)
%         break;
%     end
end
Result.BestSol=Bestsol;
Result.Population=Imperial;
Result.BestCost=Bestcost;
Result.Time=Time;
end

function Ans=RouletteWheelSelection(p,beta)
P=exp(-beta*p/max(p));
P=P/sum(P);
c=cumsum(P);   
Ans=find(rand()<=c,1,'first');       
end
